From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Shane Freeder <theboyetronic@gmail.com>
Date: Sun, 18 Nov 2018 19:49:56 +0000
Subject: [PATCH] Make the default permission message configurable


diff --git a/src/main/java/com/destroystokyo/paper/PaperCommand.java b/src/main/java/com/destroystokyo/paper/PaperCommand.java
index a7182a4c64980aa19b8493ac9c2bb762603e615b..006f2e900de3a665fa48cac877511277a900be62 100644
--- a/src/main/java/com/destroystokyo/paper/PaperCommand.java
+++ b/src/main/java/com/destroystokyo/paper/PaperCommand.java
@@ -52,7 +52,7 @@ public class PaperCommand extends Command {
 
     private static boolean testPermission(CommandSender commandSender, String permission) {
         if (commandSender.hasPermission(BASE_PERM + permission) || commandSender.hasPermission("bukkit.command.paper")) return true;
-        commandSender.sendMessage(ChatColor.RED + "I'm sorry, but you do not have permission to perform this command. Please contact the server administrators if you believe that this is in error."); // Sorry, kashike
+        commandSender.sendMessage(Bukkit.getPermissionMessage()); // Sorry, kashike
         return false;
     }
 
diff --git a/src/main/java/com/destroystokyo/paper/PaperConfig.java b/src/main/java/com/destroystokyo/paper/PaperConfig.java
index ebd5a619b49f423408e1a72a94e40010e997353d..ad95c9a3d10d15d558e4bcca5be76a101a6a66ed 100644
--- a/src/main/java/com/destroystokyo/paper/PaperConfig.java
+++ b/src/main/java/com/destroystokyo/paper/PaperConfig.java
@@ -21,8 +21,10 @@ import com.google.common.collect.Lists;
 import net.kyori.adventure.text.Component;
 import net.kyori.adventure.text.minimessage.MiniMessage;
 import net.kyori.adventure.text.serializer.legacy.LegacyComponentSerializer;
+import net.kyori.adventure.text.format.NamedTextColor;
 import net.minecraft.server.MinecraftServer;
 import org.bukkit.Bukkit;
+import org.bukkit.ChatColor;
 import org.bukkit.command.Command;
 import org.bukkit.configuration.ConfigurationSection;
 import org.bukkit.configuration.InvalidConfigurationException;
@@ -328,6 +330,16 @@ public class PaperConfig {
         connectionThrottleKickMessage = miniMessage.deserialize(getString("messages.kick.connection-throttle", defaultConnectionThrottleKickMessage));
     }
 
+    private static final String defaultNoPermissionMessage = "I'm sorry, but you do not have permission to perform this command. Please contact the server administrators if you believe that this is in error.";
+    public static Component noPermissionMessage = Component.text(defaultNoPermissionMessage, NamedTextColor.RED);
+    private static void noPermissionMessage() {
+        if (version < 28) {
+            noPermissionMessage = MiniMessage.miniMessage().deserialize(getString("messages.no-permission", "&c" +  defaultNoPermissionMessage));
+            set("messages.no-permission", MiniMessage.miniMessage().serialize(noPermissionMessage));
+        }
+        noPermissionMessage = MiniMessage.miniMessage().deserialize(getString("messages.no-permission", "<red>" + defaultNoPermissionMessage));
+    }
+
     private static void savePlayerData() {
         Object val = config.get("settings.save-player-data");
         if (val instanceof Boolean) {
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftServer.java b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
index b0f7f44569f119d9e16bc468124b69244c61bf87..07f987a148a168a3fc9704f3e2d03cb3b156e6eb 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftServer.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
@@ -2600,6 +2600,16 @@ public final class CraftServer implements Server {
         return com.destroystokyo.paper.PaperConfig.suggestPlayersWhenNullTabCompletions;
     }
 
+    @Override
+    public String getPermissionMessage() {
+        return ""; // TODO
+    }
+
+    @Override
+    public net.kyori.adventure.text.Component permissionMessage() {
+        return com.destroystokyo.paper.PaperConfig.noPermissionMessage;
+    }
+
     @Override
     public com.destroystokyo.paper.profile.PlayerProfile createProfile(@Nonnull UUID uuid) {
         return createProfile(uuid, null);
